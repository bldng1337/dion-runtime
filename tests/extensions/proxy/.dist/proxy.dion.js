//{"id":"proxy","name":"proxy","url":"www.example.com","icon":"www.example.com/icon.png","lang":[],"nsfw":false,"media_type":["Book"],"extension_type":[],"version":"1.0.0","license":"ISC","api_version":"*","repo":"string"}
import{fetch as i}from"network";import{getSetting as c}from"setting";class e{async validate(n){return n}async onEvent(n){switch(n.type){case"Action":return;case"FeedUpdate":return{type:n.type,customui:[],hasnext:null,length:null};case"SwapContent":return{type:n.type,customui:{type:"Text",text:"asd"}}}}async mapSource(n,t,r){return{source:n,settings:r}}async mapEntry(n,t){return{entry:n,settings:t}}async onEntryActivity(n,t,r){}async browse(n){let t=await o();return{content:(await i(`${t}/getEntries`)).json}}async search(n,t){let r=await o();return{content:(await i(`${r}/getEntries`)).json}}async handleUrl(n){return!0}async detail(n,t){let r=await o();return{entry:(await i(`${r}/getEntry`)).json,settings:t}}async source(n,t){let r=await o();return{source:(await i(`${r}/getSource`)).json,settings:t}}}async function o(){let n=await c("testdataserver","Extension"),t=n.value.data;if(n.value.type!=="String")throw Error("Failed to get Server");if(t.endsWith("/"))return t.substring(0,t.length-1);return t}function s(n,t="Extension error"){if(!n)throw Error(`Assert failed: ${t}`)}import{getProxyAddress as y}from"network";import{registerSetting as l}from"setting";class S extends e{async load(){let n=await y();console.log(`[Proxy Test] Extension proxy address: ${n}`),await l("proxyAddress",{visible:!1,label:"Proxy Address",default:{type:"String",data:""},value:{type:"String",data:n||""}},"Extension")}async handleProxy(n){let t=await o();if(console.log(`[Proxy Test] handleProxy called for: ${n.uri}`),n.uri.includes("/redirect-test"))return console.log("[Proxy Test] Redirecting to /redirected"),{type:"redirect",request:{method:"GET",uri:`${t}/redirected`,version:11,headers:{},body:""}};if(n.uri.includes("/custom-response"))return console.log("[Proxy Test] Returning custom response"),{type:"response",status:200,headers:{"Content-Type":["application/json"],"X-Custom-Header":["test-value"]},body:JSON.stringify({message:"Custom response from proxy"})};if(n.uri.includes("/modify-headers")){console.log("[Proxy Test] Modifying headers and forwarding");let r={...n.headers};return r["X-Proxy-Modified"]=["true"],{type:"redirect",request:{method:n.method,uri:`${t}/modify-headers`,version:n.version,headers:r,body:n.body}}}if(n.uri.includes("/echo-body")&&n.method==="POST")return console.log("[Proxy Test] Echoing POST body"),{type:"response",status:200,headers:{"Content-Type":["application/json"]},body:JSON.stringify({echoed:n.body,method:n.method})};if(n.uri.includes("/error-test"))return console.log("[Proxy Test] Returning error response"),{type:"response",status:404,headers:{"Content-Type":["text/plain"]},body:"Resource not found"};if(n.uri.includes("/header-test")){console.log("[Proxy Test] Testing header format");let r=n.headers["x-test-header"];return s(r!==void 0,"x-test-header is undefined"),{type:"response",status:200,headers:{"Content-Type":["application/json"]},body:JSON.stringify({receivedHeader:r[0],uri:n.uri})}}if(n.uri.includes("/test-https"))return{type:"redirect",request:{method:"GET",uri:"https://www.example.com",version:11,headers:{}}};return console.log(`[Proxy Test] Default redirect to ${t}`),{type:"redirect",request:{method:n.method,uri:`${t}${new URL(n.uri).pathname}`,version:n.version,headers:n.headers,body:n.body}}}}export{S as default};
