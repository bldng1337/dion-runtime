#!/usr/bin/env bun
// @bun
var{$:g,file:w}=globalThis.Bun;import{ValiError as l}from"valibot";import{valibot as o}from"@dion-js/runtime-types/extension";var{$:f,file:u}=globalThis.Bun;import*as e from"valibot";async function c(r){let t,s;try{t=(await f`git config --get remote.origin.url`.quiet()).stdout.toString().trim()}catch(n){s=n}let i=e.parse(e.omit(o.DionRepoIndex,["repo_index_version","content"]),await u(r?.repoIndexPath??"../../package.json").json());if(i.url!==void 0)return i.url;if(s!==void 0){console.error(`Failed to get Repo URL from git config: ${s}`);return}return t}async function a(r){let t=e.parse(e.omit(o.ExtensionMetadata,["repo"]),await u(r?.extensionPath??"./package.json").json());if(r?.repoUrl===void 0)return{...t,repo:await c({repoIndexPath:r?.repoIndexPath})};return{...t,repo:r?.repoUrl}}async function d(){let r=await Bun.build({entrypoints:["src/main.ts"],loader:{".gql":"text",".txt":"text"},minify:!0,target:"browser",tsconfig:"./tsconfig.json",external:["network","permission","setting","parse","convert","auth"],format:"esm"});if(!r.success)throw AggregateError(r.logs);if(r.outputs.length===0)throw Error("No outputs found");let t=await r.outputs[0]?.text();if(t===void 0)throw Error("No output found");return t}async function m(){try{await g`rm -rf .dist && mkdir .dist`;let[r,t]=await Promise.all([a(),d()]);await w(`./.dist/${r.name}.dion.js`).write(`//${JSON.stringify(r)}
${t}`)}catch(r){if(console.error("Error during build:"),r instanceof l){console.error("Validation error:");for(let t of r.issues)console.error(`  ${t.path?.map((s)=>s.key).join(".")}: ${t.message}`)}else console.error(r);process.exit(1)}}m();
